# ============================================
# Core Settings (shared by all zones)
# ============================================
# Include this ONCE in your device config.
# Contains global balancing parameters, pipe settings, and status sensors.

# ============================================
# Global Balancing Parameters
# ============================================
number:
  - platform: template
    name: "Minimum Valve Opening"
    id: ${id_prefix}minimum_valve_opening
    icon: "mdi:valve"
    unit_of_measurement: "%"
    optimistic: true
    min_value: 0
    max_value: 50
    step: 5
    restore_value: true
    initial_value: 25
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings

  - platform: template
    name: "Comfort Band"
    id: ${id_prefix}comfort_band
    icon: "mdi:thermometer-lines"
    unit_of_measurement: "Â°C"
    optimistic: true
    min_value: 0.2
    max_value: 2.0
    step: 0.1
    restore_value: true
    initial_value: 0.5
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings

  - platform: template
    name: "Maintenance Base"
    id: ${id_prefix}maintenance_base
    icon: "mdi:wrench"
    unit_of_measurement: "%"
    optimistic: true
    min_value: 20
    max_value: 70
    step: 5
    restore_value: true
    initial_value: 45
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings

  - platform: template
    name: "Demand Boost"
    id: ${id_prefix}demand_boost
    icon: "mdi:fire"
    unit_of_measurement: "%"
    optimistic: true
    min_value: 0
    max_value: 50
    step: 5
    restore_value: true
    initial_value: 30
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings

  - platform: template
    name: "Boost Factor"
    id: ${id_prefix}boost_factor
    icon: "mdi:speedometer"
    unit_of_measurement: "%"
    optimistic: true
    min_value: 50
    max_value: 200
    step: 5
    restore_value: true
    initial_value: 100
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings

  - platform: template
    name: "Min Movement"
    id: ${id_prefix}min_movement
    icon: "mdi:arrow-expand-horizontal"
    unit_of_measurement: "%"
    optimistic: true
    min_value: 1
    max_value: 20
    step: 1
    restore_value: true
    initial_value: 5
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings

  # Pipe settings (shared by all zones)
  - platform: template
    name: "Pipe Spacing"
    id: ${id_prefix}pipe_spacing
    icon: "mdi:arrow-expand-horizontal"
    unit_of_measurement: "mm"
    entity_category: config
    optimistic: true
    min_value: 100
    max_value: 300
    step: 50
    restore_value: true
    initial_value: 150
    web_server:
      sorting_group_id: sorting_group_settings
    
  - platform: template
    name: "Pipe Volume per Meter"
    id: ${id_prefix}pipe_volume_per_meter
    icon: "mdi:pipe"
    unit_of_measurement: "L/m"
    optimistic: true
    min_value: 0.05
    max_value: 0.25
    step: 0.001
    restore_value: true
    initial_value: 0.113
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings

# ============================================
# Pipe Type Selector
# ============================================
select:
  - platform: template
    name: "Pipe Type"
    id: ${id_prefix}pipe_type
    icon: "mdi:pipe"
    optimistic: true
    restore_value: true
    entity_category: config
    options:
      - "PEX 12x2"
      - "PEX 14x2"
      - "PEX 16x2"
      - "PEX 17x2"
      - "PEX 18x2"
      - "PEX 20x2"
    initial_option: "PEX 16x2"
    on_value:
      then:
        - lambda: |-
            float volume = 0.113;
            if (x == "PEX 12x2") volume = 0.050;
            else if (x == "PEX 14x2") volume = 0.079;
            else if (x == "PEX 16x2") volume = 0.113;
            else if (x == "PEX 17x2") volume = 0.133;
            else if (x == "PEX 18x2") volume = 0.154;
            else if (x == "PEX 20x2") volume = 0.201;
            auto call = id(${id_prefix}pipe_volume_per_meter).make_call();
            call.set_value(volume);
            call.perform();
    web_server:
      sorting_group_id: sorting_group_settings

# ============================================
# Balancing Switch
# ============================================
switch:
  - platform: template
    name: "Hydraulic Balancing"
    id: ${id_prefix}balancing_enabled
    icon: "mdi:scale-balance"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings

  - platform: template
    name: "Standalone Mode"
    id: ${id_prefix}standalone_mode
    icon: "mdi:lan-disconnect"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings

# ============================================
# Status Sensors
# ============================================
sensor:
  - platform: template
    name: "Average Valve Position"
    id: ${id_prefix}avg_valve_position
    icon: "mdi:valve"
    unit_of_measurement: "%"
    accuracy_decimals: 1
    update_interval: 30s
    entity_category: diagnostic
    lambda: |-
      float sum = 0;
      int count = 0;
      for (auto *cover : App.get_covers()) {
        sum += cover->position * 100.0;
        count++;
      }
      if (count > 0) return sum / count;
      return 0;
    web_server:
      sorting_group_id: sorting_group_status

  - platform: template
    name: "Active Zones"
    id: ${id_prefix}active_zones_count
    icon: "mdi:counter"
    accuracy_decimals: 0
    update_interval: 30s
    entity_category: diagnostic
    lambda: |-
      int count = 0;
      for (auto *cover : App.get_covers()) {
        if (cover->position > 0.01) count++;
      }
      return count;
    web_server:
      sorting_group_id: sorting_group_status

# ============================================
# Status Text Sensors
# ============================================
text_sensor:
  - platform: template
    name: "Main Logs"
    id: ${id_prefix}main_logs
    icon: "mdi:text-box-outline"
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_debug
    
  - platform: template
    name: "Position Logs"
    id: ${id_prefix}position_logs
    icon: "mdi:text-box-check-outline"
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_debug
    
  - platform: template
    name: "BEMF Logs"
    id: ${id_prefix}bemf_logs
    icon: "mdi:flash"
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_debug

  - platform: template
    name: "Controller Mode"
    id: ${id_prefix}controller_mode
    icon: "mdi:cog"
    update_interval: 30s
    entity_category: diagnostic
    lambda: |-
      bool wifi_connected = wifi::global_wifi_component->is_connected();
      bool api_connected = api_is_connected();
      if (!wifi_connected) return {"Offline"};
      if (!api_connected) return {"Standalone"};
      return {"Connected"};
    web_server:
      sorting_group_id: sorting_group_status

  - platform: template
    name: "System Status"
    id: ${id_prefix}system_status
    icon: "mdi:information-outline"
    update_interval: 30s
    entity_category: diagnostic
    lambda: |-
      float avg = id(${id_prefix}avg_valve_position).state;
      bool bal = id(${id_prefix}balancing_enabled).state;
      if (!bal) return {"Balancing OFF"};
      if (avg < 30) return {"Low demand"};
      if (avg > 90) return {"High demand"};
      if (avg >= 50 && avg <= 80) return {"Optimal"};
      return {"Normal"};
    web_server:
      sorting_group_id: sorting_group_status
